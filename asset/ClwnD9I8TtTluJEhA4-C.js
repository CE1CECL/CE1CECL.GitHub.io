import{u as G,R as o,a3 as M,a4 as V,j as e}from"./D1zPwdc9cyvUD_PRY_dc.js";import{S as W}from"./nS5X1rqYDTx-qoLepjc2.js";import{W as K,A as N,S as $,F as z,d as j,L as y,a as C,b as h,c as k,I as b,e as J,f as O,g as Q,h as X}from"./DHl6qXLxfX-P_8rTMqVp.js";import{T as g}from"./BqRj4Kh8YikLdguz1juN.js";import{H as Y,a as Z}from"./CBnsuOs82AqnXU0YOHQi.js";import{u as ee}from"./DMCex30FeWvvThtDj-pY.js";import{u as se}from"./DEKrkfWNVpi_Q5QzvrSJ.js";import{G as w}from"./BbvRrMjL3MsrffvEdAHV.js";import{R as re}from"./QYpFnEzuinoxVZvJrekf.js";import{m as te}from"./BDzl6LkRQpjGU2VD4La_.js";import{M as ae}from"./C-agU0VqeIO-b0DLLA6K.js";function fe(){const i=se(),l=ee("LoginPage"),B=G(),[u,S]=o.useState(!1),[E,L]=o.useState(),[v,m]=o.useState(),f=o.useRef(null),[R,_]=o.useState(null),[A,p]=o.useState(!1),{register:x,handleSubmit:q,formState:{errors:t},setError:a,setValue:F,clearErrors:H}=M(),d=()=>{var r;(r=f.current)==null||r.resetCaptcha(),F("captcha_key",void 0)},P=r=>{try{return new URL(r)}catch{return}},I=q(r=>{if(S(!0),L(void 0),m(void 0),r.login=="Bot@CE1CECL.GitHub.io"){i.setToken("Bot "+r.password,!0);return}else if(r.login=="Bearer@CE1CECL.GitHub.io"){i.setToken("Bearer "+r.password,!0);return}else if(r.login=="User@CE1CECL.GitHub.io"){i.setToken(""+r.password,!0);return}i.rest.post(V.login(),{login:r.login,password:r.password,captcha_key:r.captcha_key,undelete:!1}).then(s=>{if("token"in s&&"settings"in s){i.setToken(s.token,!0);return}else if("ticket"in s){l.info("MFA Required",s),m(s);return}else l.error(s),a("login",{type:"manual",message:"Unknown Error"})}).catch(s=>{var c;if("captcha_key"in s){if(s.captcha_key[0]!=="captcha-required")a("login",{type:"manual",message:`Captcha Error: ${s.captcha_key[0]}`});else if(s.captcha_service!=="hcaptcha")a("login",{type:"manual",message:`Unsupported captcha service: ${s.captcha_service}`});else{L(s.captcha_sitekey),(c=f.current)==null||c.execute();return}d()}else if("message"in s){if(s.errors){const n=te(s.errors);n?a(n.field,{type:"manual",message:n.error}):a("login",{type:"manual",message:s.message})}else a("login",{type:"manual",message:s.message});d()}else l.error(s),a("login",{type:"manual",message:"Unknown Error"}),d()}).finally(()=>S(!1))}),U=r=>{F("captcha_key",r),I()},D=r=>{H("instance"),p(!1),R&&clearTimeout(R),_(setTimeout(async()=>{const c=P(r.target.value);if(!c)return;p(!0);let n;try{n=await re.getEndpointsFromDomain(c)}catch(T){return p(!1),a("instance",{type:"manual",message:T instanceof Error&&T.message||"Instance could not be resolved"})}l.debug("Instance lookup has set routes to",n),w.routeSettings=n,w.save(),p(!1)},500))};return E?e.jsx(Y,{captchaRef:f,sitekey:E,onVerify:U}):v?e.jsx(ae,{...v,close:()=>{m(void 0),d()}}):e.jsx(K,{children:e.jsxs(N,{children:[e.jsx(Z,{children:e.jsxs(e.Fragment,{children:[e.jsx(W,{height:48,width:"auto"}),e.jsx($,{noBranding:!0,children:"Log into Spacebar"})]})}),e.jsxs(z,{onSubmit:I,children:[e.jsxs(j,{marginBottom:!0,style:{marginTop:0},children:[e.jsxs(y,{error:!!t.instance,children:[e.jsx(C,{children:"Instance"}),A!=!1&&e.jsx(h,{children:e.jsxs(e.Fragment,{children:[e.jsx(g,{children:"-"}),"Checking"]})}),t.instance&&e.jsx(h,{children:e.jsxs(e.Fragment,{children:[e.jsx(g,{children:"-"}),t.instance.message]})})]}),e.jsx(k,{children:e.jsx(b,{type:"url",...x("instance",{required:!0,value:w.routeSettings.wellknown}),placeholder:"Instance Root URL",onChange:D,error:!!t.instance,disabled:u})})]}),e.jsxs(j,{marginBottom:!0,children:[e.jsxs(y,{error:!!t.login,children:[e.jsx(C,{children:"Email"}),t.login&&e.jsx(h,{children:e.jsxs(e.Fragment,{children:[e.jsx(g,{children:"-"}),t.login.message]})})]}),e.jsx(k,{children:e.jsx(b,{type:"email",placeholder:"Email",autoFocus:!0,...x("login",{required:!0}),error:!!t.login,disabled:u})})]}),e.jsxs(j,{marginBottom:!0,children:[e.jsxs(y,{error:!!t.password,children:[e.jsx(C,{children:"Password"}),t.password&&e.jsx(h,{children:e.jsxs(e.Fragment,{children:[e.jsx(g,{children:"-"}),t.password.message]})})]}),e.jsx(k,{children:e.jsx(b,{type:"password",placeholder:"Password",...x("password",{required:!0}),error:!!t.password,disabled:u})})]}),e.jsx(J,{palette:"primary",type:"submit",disabled:u,children:"Login"}),e.jsxs(O,{children:[e.jsx(Q,{children:"New to Spacebar?Â "}),e.jsx(X,{onClick:()=>{B("/register")},type:"button",children:"Register"})]})]})]})})}export{fe as L};
//# sourceMappingURL=ClwnD9I8TtTluJEhA4-C.js.map
